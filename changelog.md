# Changelog

## [Unreleased]

### Added
- Улучшенная категоризация поисковых запросов:
  - Новые категории: доставка_город, доставка_общий, коммерческий, информационный, прочее
  - Автоматическое определение категорий на основе ключевых слов
  - Скрипт для обновления категорий исторических данных
- Анализ поисковых запросов по городам:
  - Добавлен класс CityAnalyzer для анализа статистики по городам
  - Улучшенные SQL запросы с обработкой NULL значений
  - Детальное логирование процесса анализа
- Интеграция с CRM API:
  - Добавлена таблица crm_orders для хранения заказов
  - Реализован скрипт для получения и сохранения заказов
  - Автоматическое обновление данных о заказах
  - Статистика по статусам заказов
- Переход на Service Account для Google сервисов:
  - Единый сервисный аккаунт для GSC и GA4
  - Обновлена документация по настройке Google API
  - Добавлены скрипты для тестирования подключения
- Централизация хранения учетных данных:
  - Все учетные данные перенесены в таблицу credentials
  - Удалены .env файлы
  - Обновлен CredentialsManager для работы со всеми сервисами
- Настройка Enhanced Measurement в GTM:
  - Добавлен скрипт setup_gtm_enhanced.py для автоматической настройки
  - Реализовано отслеживание:
    - Загрузки файлов (PDF, DOC, XLS и др.)
    - Внешние ссылки
    - Отправка форм
    - Время на странице (30 секунд)
  - Интеграция с GA4 через Measurement ID

### Changed
- Обновлен скрипт анализа позиций:
  - Группировка по новым категориям запросов
  - Улучшенная фильтрация значимых изменений
  - Более детальная статистика по изменениям
- Оптимизирована обработка статистики:
  - Добавлено использование COALESCE для корректной обработки NULL значений
  - Улучшена точность расчета метрик (клики, показы, CTR, позиции)
- Улучшена система аутентификации:
  - Переход с OAuth2 на Service Account для Google API
  - Упрощен процесс подключения новых сервисов
  - Повышена безопасность хранения учетных данных

### Fixed
- Исправлена обработка старых категорий в базе данных
- Улучшена точность категоризации
- Исправлены SQL запросы для корректной работы с городами
- Добавлена обработка ошибок при анализе данных

## [2024-12-17]
### Added
- Добавлен URL страницы в выгрузку топ запросов в Google Sheets
- Добавлены отдельные листы для Астаны и Алматы с фильтрацией по городам
- Увеличено количество запросов до 200
- Добавлен показатель "Показы" в таблицу
- Обновлена документация по настройке Service Account в workflow.md
- Добавлена SQL миграция для учетных данных Google Analytics
- Добавлены примеры использования CredentialsManager
- Создан сервис GTMService для работы с Google Tag Manager API
- Добавлены методы для анализа тегов, триггеров и переменных GTM
- Добавлена SQL миграция для учетных данных GTM
- Добавлена документация по работе с GTM в workflow.md
- Настроено e-commerce отслеживание в GTM:
  - Добавлены события: view_item, add_to_cart, begin_checkout, purchase, refund
  - Настроены переменные DataLayer для e-commerce данных
  - Создан Custom HTML тег для отправки событий в GA4
- Добавлена документация по настройке GTM (docs/gtm.md):
  - Инструкции по установке GTM на сайт
  - Описание e-commerce событий и параметров
  - Руководство по проверке корректности отправки данных

### Changed
- Улучшен формат таблицы с данными из Search Console
- Оптимизирован код для работы с Google Sheets API
- Переработан класс GoogleAnalytics для использования CredentialsManager
- Централизовано хранение всех учетных данных в таблице credentials
- Обновлена структура документации в workflow.md
- Обновлена структура хранения учетных данных в таблице credentials
- Обновлены миграции для работы с JSONB полем credentials
- Обновлен GTM сервис для работы с новой структурой учетных данных

### Fixed
- Исправлены дублирующиеся метрики в GA4 отчетах
- Улучшено форматирование вывода статистики по товарам

## [2024-12-13]
### Added
- Добавлен сервис `AnalyticsService` для работы с Google Analytics API
- Добавлен скрипт `setup_analytics_credentials.py` для настройки учетных данных GA4
### Changed
- Обновлена структура работы с Google Analytics API для использования сервисного аккаунта

## [2024-12-11] - Интеграция с Supabase и создание структуры базы данных

### Добавлено
- Создана структура базы данных в Supabase для хранения SEO метрик
- Реализованы таблицы для хранения данных по городам и поисковым запросам
- Добавлены таблицы для ежедневных, недельных и месячных метрик
- Создана система отслеживания изменений позиций и аномалий
- Настроены индексы для оптимизации запросов

### Улучшено
- Реализована система версионирования данных через timestamps
- Добавлены внешние ключи для обеспечения целостности данных
- Оптимизирована структура таблиц для эффективного хранения и запросов

### Технические детали
- Настроено подключение к Supabase через пул соединений
- Реализованы триггеры для автоматического обновления временных меток
- Добавлены индексы для часто используемых полей
- Создана документация по структуре базы данных

## [2024-12-11] - Улучшение анализа SEO данных

### Добавлено
- Категоризация поисковых запросов по городам и типам
- Детальный анализ запросов с доставкой по городам
- Группировка похожих запросов (например, "доставка цветов алматы" и "цветы алматы доставка")
- Статистика по позициям в поисковой выдаче для каждого города

### Изменено
- Упрощен код сбора данных из Google Search Console
- Улучшен формат вывода статистики
- Оптимизирована обработка данных для более точного анализа

### Исправлено
- Удалены избыточные временные измерения для улучшения производительности
- Исправлена обработка дубликатов в запросах
- Улучшена обработка пустых значений в данных

### Технические детали
- Обновлен `GSCCollector` для более эффективного сбора данных
- Добавлены новые функции анализа в `analyze_cvety_data.py`
- Реализована новая система категоризации запросов
- Добавлено сохранение результатов анализа в CSV файлы

### Следующие шаги
- Добавить анализ сезонности для каждого города
- Улучшить отслеживание конверсий по типам запросов
- Реализовать автоматические рекомендации по оптимизации позиций

## [1.0.0] - 2023-12-13

### Added
- Базовый функционал для работы с Google Search Console API
- Система хранения данных в Supabase
- Базовый анализ позиций и CTR
